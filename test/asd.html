import { NewsletterPortalTable } from './NewsletterPortalTable';
import { Box, IconButton, Input, InputGroup } from '@chakra-ui/react';
import { Colors, useColorMode } from '@loim/loim-ui';
import { LuSearch, LuPencil, LuSave } from 'react-icons/lu';
import { useState } from 'react';
import type { GridApi } from 'ag-grid-community';

export const NewsletterPortalPage = () => {
  const { colorMode } = useColorMode();
  const borderColor =
    colorMode === 'dark' ? Colors.gray[800].value : Colors.gray[100].value;

  const [editMode, setEditMode] = useState(false);
  const [gridApi, setGridApi] = useState<GridApi | null>(null);

  const handleSave = async () => {
    if (!gridApi) return;

    const changedRows: any[] = [];

    // collect only updated rows
    gridApi.forEachNode((node) => {
      if (node.data && node.data._dirty) {
        changedRows.push(node.data);
      }
    });

    if (changedRows.length === 0) {
      setEditMode(false);
      return;
    }

    try {
      const response = await fetch(
        'http://nycuapp01.biz.lodh.com:8011/salesportal/api/crud/newsletter',
        {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json; charset=utf-8',
            cache: 'no-cache',
          },
          body: JSON.stringify(changedRows),
        }
      );

      if (!response.ok) {
        console.error('Save failed');
        return;
      }

      // success â†’ exit edit mode
      setEditMode(false);

      // clear dirty flags
      gridApi.forEachNode((node) => {
        if (node.data) node.data._dirty = false;
      });

    } catch (err) {
      console.error('Error while saving:', err);
    }
  };

  return (
    <>
      <Box>
        <Box
          bg={
            colorMode === 'dark'
              ? Colors.gray[900].value
              : Colors.gray[100].value
          }
          borderBottom={`1px solid ${borderColor}`}
          padding="2.5rem 1.5rem"
        >
          <InputGroup
            width="40vw"
            border="1px solid gray"
            startElement={<LuSearch />}
          >
            <Input placeholder="Search ..." />
          </InputGroup>

          {!editMode && (
            <IconButton
              marginLeft="1rem"
              aria-label="Edit"
              onClick={() => setEditMode(true)}
            >
              <LuPencil />
            </IconButton>
          )}

          {editMode && (
            <IconButton
              marginLeft="1rem"
              aria-label="Save"
              onClick={handleSave}
            >
              <LuSave />
            </IconButton>
          )}
        </Box>
      </Box>

      <NewsletterPortalTable
        editMode={editMode}
        onGridReadyExternal={setGridApi}
      />
    </>
  );
};







import { useEffect, useState } from 'react';
import { AgGridReact } from 'ag-grid-react';
import type { GridApi, GridReadyEvent } from 'ag-grid-community';

import { newsletterPortalColumnDefs } from './newsletter-portal-column-defs';
import { useAgGridTheme } from '@loim/loim-ui';

type NewsletterPortalTableProps = {
  editMode: boolean;
  onGridReadyExternal?: (api: GridApi) => void;
};

export const NewsletterPortalTable = ({
  editMode,
  onGridReadyExternal,
}: NewsletterPortalTableProps) => {
  const [data, setData] = useState([]);
  const [columnDef] = useState(newsletterPortalColumnDefs);
  const [loading, setLoading] = useState(false);

  const { agGridTheme } = useAgGridTheme();

  useEffect(() => {
    setLoading(true);

    fetch(
      'http://nycuapp01.biz.lodh.com:8011/salesportal/api/crud/newsletter',
      {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json; charset=utf-8',
          cache: 'no-cache',
        },
      }
    )
      .then((res) => res.json())
      .then(setData)
      .finally(() => setLoading(false));
  }, []);

  const handleGridReady = (params: GridReadyEvent) => {
    onGridReadyExternal?.(params.api);
  };

  return (
    <div style={{ margin: '2px', padding: '2px', height: '74.5vh', width: '100vw' }}>
      <AgGridReact
        rowData={data}
        columnDefs={columnDef}
        context={{ editMode }}
        theme={agGridTheme}
        loading={loading}
        onGridReady={handleGridReady}
        stopEditingWhenCellsLoseFocus={true}
      />
    </div>
  );
};










  import type { ColDef } from 'ag-grid-community';
import React from 'react';

/* -------------------------------------------------------
   Editable Cell Renderer (Person/Firm, Location, Info)
------------------------------------------------------- */
const EditableCellRenderer = (params: any) => {
  const { editMode } = params.context;

  if (!editMode) {
    return React.createElement(
      "span",
      { style: { padding: "4px" } },
      params.value ?? ""
    );
  }

  const onChange = (event: any) => {
    params.node.setDataValue(params.colDef.field, event.target.value);
    params.node.data._dirty = true; // mark row as modified
  };

  const isMultiline = params.colDef.field === "description";

  return React.createElement(isMultiline ? "textarea" : "input", {
    value: params.value ?? "",
    onChange,
    rows: isMultiline ? 3 : undefined,
    style: {
      width: "100%",
      padding: "4px",
      border: "1px solid #ccc",
      borderRadius: "4px",
      resize: isMultiline ? "vertical" : "none",
      fontSize: "0.875rem"
    }
  });
};

/* -------------------------------------------------------
   Download Cell Renderer
------------------------------------------------------- */
const DownloadCellRenderer = (params: any) => {
  const downloadURL =
    "http://nycuapp01.biz.lodh.com:8011/salesportal/api/downloadFiles?fileLocations=";

  let link = params.value?.replaceAll("\\", "%5C") ?? "";

  let fileLocationArr = link
    .split(";")
    .map((s: string) => s.trim())
    .filter(Boolean);

  return React.createElement(
    "div",
    {
      style: {
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        alignItems: "center",
        rowGap: "4px",
        height: "100%",
        textAlign: "center",
      },
    },
    fileLocationArr.map((url: string, index: number) => {
      const fileName = url.split("%5C").pop() || url;

      return React.createElement(
        "a",
        {
          key: index,
          href: downloadURL + url,
          target: "_blank",
          rel: "noopener noreferrer",
          style: {
            color: "#3182CE",
            textDecoration: "underline",
            cursor: "pointer",
            whiteSpace: "nowrap",
          },
        },
        fileName
      );
    })
  );
};

/* -------------------------------------------------------
   COLUMN DEFINITIONS (COMPLETE)
------------------------------------------------------- */
export const newsletterPortalColumnDefs: Array<ColDef> = [
  {
    headerName: 'Date',
    field: 'asOfDate',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 120,
  },

  {
    headerName: 'Section',
    field: 'section',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 200,
  },

  {
    headerName: 'Strategy',
    field: 'strategy',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 120,
  },

  {
    headerName: 'Person/Firm',
    field: 'personFirm',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 150,
    cellRenderer: EditableCellRenderer,
  },

  {
    headerName: 'Location',
    field: 'countryRegion',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 150,
    cellRenderer: EditableCellRenderer,
  },

  {
    headerName: 'Information',
    field: 'description',
    sortable: true,
    resizable: true,
    filter: "agTextColumnFilter",
    suppressMenu: true,
    floatingFilter: true,
    width: 500,
    autoHeight: true,
    wrapText: true,
    cellRenderer: EditableCellRenderer,
  },

  {
    headerName: "Link",
    field: "fileLocation",
    autoHeight: true,
    wrapText: false,
    sortable: true,
    resizable: true,
    suppressMenu: true,
    width: 250,
    cellRenderer: DownloadCellRenderer,
  },
];


        
