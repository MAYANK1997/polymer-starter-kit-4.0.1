import { NewsletterPortalTable } from './NewsletterPortalTable';
import { Box, Input, InputGroup } from '@chakra-ui/react';
import { Colors, useColorMode } from '@loim/loim-ui';
import { LuSearch } from 'react-icons/lu';
import { useState } from 'react';

export const NewsletterPortalPage = () => {
  const { colorMode } = useColorMode();
  const borderColor =
    colorMode === 'dark' ? Colors.gray[800].value : Colors.gray[100].value;

  // quick filter text for AG Grid
  const [searchText, setSearchText] = useState('');   // üîç global search text

  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchText(e.target.value);
  };

  return (
    <>
      <Box>
        <Box
          bg={
            colorMode === 'dark'
              ? Colors.gray[900].value
              : Colors.gray[100].value
          }
          borderBottom={`1px solid ${borderColor}`}
          padding="2.5rem 1.5rem"
          display="flex"
          alignItems="center"
        >
          <InputGroup
            width="40vw"
            border="1px solid gray"
            startElement={<LuSearch />}
          >
            <Input
              placeholder="Search ..."
              value={searchText}
              onChange={handleSearchChange}
            />
          </InputGroup>
        </Box>
      </Box>

      <NewsletterPortalTable
        quickFilterText={searchText}
      />
    </>
  );
};





  import { useEffect, useState, useCallback } from 'react';
import { AgGridReact } from 'ag-grid-react';
import type {
  GridReadyEvent,
  CellDoubleClickedEvent,
  CellValueChangedEvent,
} from 'ag-grid-community';

import { newsletterPortalColumnDefs } from './newsletter-portal-column-defs';
import { useAgGridTheme } from '@loim/loim-ui';

type NewsletterPortalTableProps = {
  quickFilterText?: string;
};

export const NewsletterPortalTable = ({
  quickFilterText = '',
}: NewsletterPortalTableProps) => {
  const [data, setData] = useState<any[]>([]);
  const [columnDef] = useState(newsletterPortalColumnDefs);
  const [loading, setLoading] = useState(false);

  const { agGridTheme } = useAgGridTheme();

  useEffect(() => {
    setLoading(true);

    fetch('http://nycuapp01.biz.lodh.com:8011/salesportal/api/crud/newsletter', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
        cache: 'no-cache',
      },
    })
      .then((response) => response.json())
      .then((rows) => {
        setData(rows ?? []);
      })
      .catch((err) => {
        console.error('Error fetching newsletter data', err);
      })
      .finally(() => {
        setLoading(false);
      });
  }, []);

  const handleGridReady = useCallback((params: GridReadyEvent) => {
    // nothing extra needed, but kept for future
  }, []);

  // Start editing explicitly on double click (keeps UX consistent)
  const onCellDoubleClicked = (params: CellDoubleClickedEvent) => {
    const colKey = params.colDef.field as string | undefined;
    if (!colKey) return;

    try {
      params.api.startEditingCell({
        rowIndex: params.rowIndex,
        colKey,
      });
    } catch (err) {
      // fallback for some AG Grid versions
      try {
        params.api.startEditingCell({
          rowIndex: params.node.rowIndex,
          colKey,
        });
      } catch (e) {
        console.warn('startEditingCell failed', e);
      }
    }
  };

  // When user finishes editing (Enter or blur) and value changed -> POST the full row
  const onCellValueChanged = async (params: CellValueChangedEvent) => {
    const updatedRow = params.data;
    if (!updatedRow) return;

    try {
      const res = await fetch(
        'http://nycuapp01.biz.lodh.com:8011/salesportal/api/crud/newsletter',
        {
          method: 'POST', // your API expects POST to same endpoint
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json; charset=utf-8',
            cache: 'no-cache',
          },
          // sending as array containing single row to match previous usage
          body: JSON.stringify([updatedRow]),
        }
      );

      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        console.error('Failed to save row:', res.status, txt);
        // optionally show toast or revert change
      } else {
        // success - you may refresh row data from response or keep local change
        // Example: no-op, AG Grid already updated the cell
      }
    } catch (err) {
      console.error('Error posting updated row', err);
    }
  };

  return (
    <div
      style={{
        margin: '2px',
        padding: '2px',
        height: '80vh',
        width: '100vw',
      }}
    >
      <AgGridReact
        rowData={data}
        columnDefs={columnDef}
        theme={agGridTheme}
        loading={loading}
        onGridReady={handleGridReady}
        onCellDoubleClicked={onCellDoubleClicked}
        onCellValueChanged={onCellValueChanged}
        stopEditingWhenCellsLoseFocus={true}
        quickFilterText={quickFilterText}
      />
    </div>
  );
};






    import type { ColDef } from 'ag-grid-community';
import React from 'react';


const DownloadCellRenderer = (params: any) => {
  const downloadURL =
    'http://nycuapp01.biz.lodh.com:8011/salesportal/api/downloadFiles?fileLocations=';

  let link = params.value?.replaceAll('\\', '%5C') ?? '';

  const fileLocationArr = link
    .split(';')
    .map((s: string) => s.trim())
    .filter(Boolean);

  return React.createElement(
    'div',
    {
      style: {
        display: 'flex',
        flexDirection: 'column', 
        justifyContent: 'center', 
        alignItems: 'center', 
        rowGap: '4px',
        height: '100%',
        textAlign: 'center',
      },
    },
    fileLocationArr.map((url: string, index: number) => {
      const fileName = url.split('%5C').pop() || url;

      return React.createElement(
        'a',
        {
          key: index,
          href: downloadURL + url,
          target: '_blank',
          rel: 'noopener noreferrer',
          style: {
            color: '#3182CE',
            textDecoration: 'underline',
            cursor: 'pointer',
            whiteSpace: 'nowrap',
          },
        },
        fileName
      );
    })
  );
};

const formatDate = (params: any) => {
  if (!params.value) return "";

  const date = new Date(params.value);
  if (isNaN(date.getTime())) return params.value;

  const day = date.getDate().toString().padStart(2, "0");

  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  const month = monthNames[date.getMonth()];

  const year = date.getFullYear(); // full 4-digit year

  return `${day}-${month}-${year}`;
};


export const newsletterPortalColumnDefs: Array<ColDef> = [
  {
    headerName: 'Date',
    field: 'asOfDate',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex: 1,
    valueFormatter: formatDate
  },

  {
    headerName: 'Section',
    field: 'section',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex: 1.2,
    autoHeight: true,
    wrapText: true,
  },

  {
    headerName: 'Strategy',
    field: 'strategy',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex: 1,
    autoHeight: true,
    wrapText: true,
  },

  
  {
    headerName: 'Person/Firm',
    field: 'personFirm',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex:1.5,
    editable: true,
    autoHeight: true,
    wrapText: true,
    
  },


  {
    headerName: 'Location',
    field: 'countryRegion',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex:1.5,
    editable: true,
    wrapText: true,
    autoHeight: true

    
  },

 
  {
    headerName: 'Information',
    field: 'description',
    sortable: true,
    resizable: true,
    filter: 'agTextColumnFilter',
    suppressMenu: true,
    floatingFilter: true,
    flex:3,
    autoHeight: true,
    wrapText: true,
    editable: true,
   
  },


  {
    headerName: 'Link',
    field: 'fileLocation',
    autoHeight: true,
    wrapText: false,
    sortable: true,
    resizable: true,
    suppressMenu: true,
    flex:2,
    cellRenderer: DownloadCellRenderer,
  },
];



        
