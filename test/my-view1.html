// IssuerHoldingsModal.tsx
import {
  Dialog,
  Portal,
  Button,
  CloseButton,
  HStack,
  VStack,
  Text,
  Box,
  Table,
} from "@chakra-ui/react";

interface IssuerHoldingsModalProps {
  isOpen: boolean;
  onClose: () => void;
  issuerDetails: any; // validated issuer + vrequest
  onProceed: () => void;
  onRefuse: () => void;
}

export function IssuerHoldingsModal({
  isOpen,
  onClose,
  issuerDetails,
  onProceed,
  onRefuse,
}: IssuerHoldingsModalProps) {
  if (!issuerDetails) return null;

  const { hgList = [], thList = [] } = issuerDetails;

  return (
    <Dialog.Root open={isOpen} onOpenChange={(open) => !open && onClose()}>
      <Portal>
        <Dialog.Backdrop />
        <Dialog.Positioner>
          <Dialog.Content bg="gray.800" color="white" maxW="90vw">
            <Dialog.Header>
              <Text fontSize="lg" fontWeight="bold">
                Issuer Holdings - {issuerDetails.validatedIssuerName || issuerDetails.vrequest?.issuerName}
              </Text>
            </Dialog.Header>
            <Dialog.CloseTrigger asChild>
              <CloseButton position="absolute" top={2} right={2} />
            </Dialog.CloseTrigger>

            <Dialog.Body>
              <VStack spacing={6} align="stretch">
                {/* Issuer Details */}
                <Box bg="gray.700" p={4} borderRadius="md">
                  <Text fontWeight="bold" mb={2}>Issuer Details</Text>
                  <HStack spacing={8} flexWrap="wrap">
                    {Object.entries(issuerDetails.vrequest || {}).map(([key, value]) => (
                      <Text key={key} fontSize="sm">
                        <strong>{key}:</strong> {value || "-"}
                      </Text>
                    ))}
                  </HStack>
                </Box>

                {/* Holdings Tab */}
                <Box>
                  <Text fontWeight="bold" mb={2}>Holdings</Text>
                  <Box overflowX="auto">
                    <Table.Root size="sm">
                      <Table.Header>
                        <Table.Row>
                          {hgList[0] &&
                            Object.keys(hgList[0]).map((key) => (
                              <Table.ColumnHeader key={key}>{key}</Table.ColumnHeader>
                            ))}
                        </Table.Row>
                      </Table.Header>
                      <Table.Body>
                        {hgList.map((holding, idx) => (
                          <Table.Row key={idx}>
                            {Object.values(holding).map((val, i) => (
                              <Table.Cell key={i}>{val?.toString() || "-"}</Table.Cell>
                            ))}
                          </Table.Row>
                        ))}
                      </Table.Body>
                    </Table.Root>
                  </Box>
                </Box>

                {/* Trade History Tab */}
                <Box>
                  <Text fontWeight="bold" mb={2}>Trade History (Last 90 days)</Text>
                  <Box overflowX="auto">
                    <Table.Root size="sm">
                      <Table.Header>
                        <Table.Row>
                          {thList[0] &&
                            Object.keys(thList[0]).map((key) => (
                              <Table.ColumnHeader key={key}>{key}</Table.ColumnHeader>
                            ))}
                        </Table.Row>
                      </Table.Header>
                      <Table.Body>
                        {thList.map((trade, idx) => (
                          <Table.Row key={idx}>
                            {Object.values(trade).map((val, i) => (
                              <Table.Cell key={i}>{val?.toString() || "-"}</Table.Cell>
                            ))}
                          </Table.Row>
                        ))}
                      </Table.Body>
                    </Table.Root>
                  </Box>
                </Box>

                {/* Action Buttons */}
                <HStack justify="flex-end" spacing={3}>
                  <Button variant="outline" colorScheme="gray" onClick={onClose}>
                    Close
                  </Button>
                  <Button onClick={onRefuse} colorScheme="red">
                    Refuse Wall Cross
                  </Button>
                  <Button onClick={onProceed} colorScheme="green">
                    Proceed to Wall Cross
                  </Button>
                </HStack>
              </VStack>
            </Dialog.Body>
          </Dialog.Content>
        </Dialog.Positioner>
      </Portal>
    </Dialog.Root>
  );
}
