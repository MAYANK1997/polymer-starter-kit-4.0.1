import { config } from "@/config";
import {
  DialogRoot,
  DialogContent,
  DialogHeader,
  DialogBody,
  DialogFooter,
  DialogTitle,
  DialogCloseTrigger,
  Button,
  HStack,
  Input,
  Textarea,
  FormControl,
  FormLabel,
} from "@chakra-ui/react";
import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toaster } from "@loim/loim-ui";

interface IssuerData {
  validatedIssuerName: string;
  issuerName: string;
  restrictionCategory: { name: string };
}

interface UnrestrictIssuerModalProps {
  open: boolean;
  onClose: () => void;
  issuer: IssuerData | null;
}

export function UnrestrictIssuerModal({
  open,
  onClose,
  issuer,
}: UnrestrictIssuerModalProps) {
  const queryClient = useQueryClient();

  const [restrictionEndDate, setRestrictionEndDate] = useState("");
  const [requester, setRequester] = useState("");
  const [notes, setNotes] = useState("");

  const mutation = useMutation({
    mutationFn: async () => {
      const res = await fetch(`${config.apis.mdmApi}/UnrestrictIssuer`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          categoryName: issuer?.restrictionCategory?.name,
          dateUnrestricted: restrictionEndDate,
          issuerName: issuer?.validatedIssuerName,
          unrestrictRequestor: requester,
          notes: notes,
        }),
      });

      if (!res.ok) throw new Error("Failed to unrestrict issuer");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["restricted-issuers"] });
      toaster.create({
        title: "Issuer Unrestricted",
        description: "The issuer has been unrestricted successfully.",
        type: "success",
        duration: 3000,
      });
      onClose();
    },
    onError: () => {
      toaster.create({
        title: "Error",
        description: "Failed to unrestrict issuer.",
        type: "error",
        duration: 3000,
      });
    },
  });

  if (!issuer) return null;

  return (
    <DialogRoot open={open} onOpenChange={(e) => !e.open && onClose()}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            Unrestrict Issuer - {issuer.validatedIssuerName}
          </DialogTitle>
          <DialogCloseTrigger />
        </DialogHeader>

        <DialogBody>
          <FormControl mb={4}>
            <FormLabel>Restriction Category</FormLabel>
            <Input value={issuer.restrictionCategory?.name || ""} isReadOnly />
          </FormControl>

          <FormControl mb={4} isRequired>
            <FormLabel>Restriction End Date</FormLabel>
            <Input
              type="date"
              value={restrictionEndDate}
              onChange={(e) => setRestrictionEndDate(e.target.value)}
            />
          </FormControl>

          <FormControl mb={4} isRequired>
            <FormLabel>Requester for Un-restriction</FormLabel>
            <Input
              value={requester}
              onChange={(e) => setRequester(e.target.value)}
              placeholder="Enter requestor name"
            />
          </FormControl>

          <FormControl mb={4}>
            <FormLabel>Un-restriction Notes</FormLabel>
            <Textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Enter notes"
            />
          </FormControl>
        </DialogBody>

        <DialogFooter>
          <HStack justify="flex-end" gap={3}>
            <Button onClick={onClose} variant="outline">
              Cancel
            </Button>
            <Button
              colorScheme="green"
              onClick={() => mutation.mutate()}
              isLoading={mutation.isPending}
            >
              Unrestrict Issuer
            </Button>
          </HStack>
        </DialogFooter>
      </DialogContent>
    </DialogRoot>
  );
}
