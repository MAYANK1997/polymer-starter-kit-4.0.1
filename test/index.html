import {
  Dialog,
  Portal,
  DialogOverlay,
  DialogContent,
  DialogHeader,
  DialogBody,
  CloseButton,
  Button,
  FormControl,
  FormLabel,
  Textarea,
  HStack,
  Text,
  useToast,
} from "@chakra-ui/react";
import { useForm } from "react-hook-form";
import { useMutation, useQueryClient } from "@tanstack/react-query";

interface RefuseWallCrossDialogProps {
  isOpen: boolean;
  onClose: () => void;
  wcId: number;
}

interface RefuseFormData {
  reason: string;
}

export function RefuseWallCrossDialog({ isOpen, onClose, wcId }: RefuseWallCrossDialogProps) {
  const { register, handleSubmit, reset, formState: { errors } } = useForm<RefuseFormData>();
  const queryClient = useQueryClient();
  const toast = useToast();

  const refuseMutation = useMutation({
    mutationFn: async (data: RefuseFormData) => {
      const res = await fetch("http://nycuapp03.biz.lodh.com:8787/wallcross/cancel", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wcId, reason: data.reason }),
      });
      if (!res.ok) throw new Error("Failed to refuse wall cross");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["wall-crossed-issuers"] });
      toast({
        title: "Wall Cross Refused",
        description: "Refusal successfully recorded.",
        status: "success",
        duration: 3000,
        isClosable: true,
      });
      reset();
      onClose();
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to refuse wall cross.",
        status: "error",
        duration: 3000,
        isClosable: true,
      });
    },
  });

  const onSubmit = (data: RefuseFormData) => refuseMutation.mutate(data);

  return (
    <Dialog.Root open={isOpen} onOpenChange={(open) => !open && onClose()}>
      <Portal>
        <Dialog.Overlay />
        <DialogContent bg="gray.800" color="white" maxW="md" p={4}>
          <DialogHeader>
            Refuse Wall Cross
            <CloseButton position="absolute" top={2} right={2} onClick={onClose} />
          </DialogHeader>
          <DialogBody>
            <form onSubmit={handleSubmit(onSubmit)}>
              <FormControl mb={4}>
                <FormLabel>Reason *</FormLabel>
                <Textarea
                  {...register("reason", { required: "Reason is required" })}
                  placeholder="Enter refusal reason"
                  bg="gray.700"
                  border="none"
                  _focus={{ bg: "gray.600" }}
                  rows={4}
                />
                {errors.reason && <Text color="red.300">{errors.reason.message}</Text>}
              </FormControl>
              <HStack justify="flex-end" spacing={3}>
                <Button variant="outline" onClick={onClose}>Cancel</Button>
                <Button type="submit" colorScheme="red" isLoading={refuseMutation.isLoading}>
                  Submit Refusal
                </Button>
              </HStack>
            </form>
          </DialogBody>
        </DialogContent>
      </Portal>
    </Dialog.Root>
  );
}
